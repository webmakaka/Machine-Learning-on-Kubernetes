# [OK!] Chapter 7. Model Deployment and Automation

<br/>

**In MLFlow mlflowdemo model should be registered**

<br/>

```
$ kubectl get pods -n ml-workshop | grep seldon
seldon-controller-manager-c5f59c56d-dxr9h              1/1     Running     0             66m
```

<br/>

### Packaging, running, and monitoring a model using Seldon Core

<br/>

```
$ kubectl get pods -n ml-workshop | grep -iE 'mlflow|minio'
```

<br/>

```
minio-ml-workshop-7fcc5dfd8-dqc65                      1/1     Running     0             67m
minio-ml-workshop-dfxc6                                0/1     Completed   2             67m
mlflow-5fb4cb5d5d-qhwgq                                2/2     Running     0             67m
mlflow-db-0                                            1/1     Running     1 (65m ago)   67m
```

<br/>

```
$ kubectl get ingresses.networking.k8s.io -n ml-workshop
```

<br/>

```
NAME                   CLASS   HOSTS                            ADDRESS        PORTS     AGE
ap-airflow2            nginx   airflow.192.168.49.2.nip.io      192.168.49.2   80, 443   67m
grafana                nginx   grafana.192.168.49.2.nip.io      192.168.49.2   80, 443   67m
jupyterhub             nginx   jupyterhub.192.168.49.2.nip.io   192.168.49.2   80, 443   67m
minio-ml-workshop-ui   nginx   minio.192.168.49.2.nip.io        192.168.49.2   80, 443   67m
mlflow                 nginx   mlflow.192.168.49.2.nip.io       192.168.49.2   80, 443   67m

```

<br/>

```
MLFLOW -> HelloMlFlow
```

<br/>

Replace:

<br/>

```
model.pkl
requirements.txt
```

<br/>

In folder:

Machine-Learning-on-Kubernetes/Chapter07.01/model_deploy_pipeline/model_build_push

<br/>

```
$ cd Machine-Learning-on-Kubernetes/Chapter07.01/model_deploy_pipeline/model_build_push/
$ docker build -t hellomlflow-manual:1.0.0 .
$ docker tag hellomlflow-manual:1.0.0 webmakaka/hellomlflow-manual:1.0.0
$ docker login
$ docker push webmakaka/hellomlflow-manual:1.0.0
```

<br/>

```
$ vi Chapter07.01/manual_model_deployment/SeldonDeploy.yaml
```

<br/>

replace

<br/>

```
- image: quay.io/ml-on-k8s/hellomlflow-manual:1.0.0
```

<br/>

on

<br/>

```
- image: webmakaka/hellomlflow-manual:1.0.0
```

<br/>

```
$ kubectl create -f Chapter07.01/manual_model_deployment/SeldonDeploy.yaml -n ml-workshop
```

<br/>

```
$ kubectl get pod -n ml-workshop | grep model-test-predictor
```

<br/>

```
$ export POD_NAME=$(kubectl get pod -o=custom-columns=NAME:.metadata.name -n ml-workshop | grep model-test-predictor)
```

<br/>

```
$ echo ${POD_NAME}
```

<br/>

```
$ kubectl get pods $POD_NAME -o jsonpath='{.spec.containers[*].name}' -n ml-workshop
```

<br/>

response:

```
model-test-predictor seldon-container-engine
```

<br/>

```
$ kubectl logs -f $POD_NAME -n ml-workshop -c model-test-predictor
```

<br/>

```
$ kubectl get all -l seldon-deployment-id=model-test -n ml-workshop
```

<br/>

```
$ export MINIKUBE_IP_ADDR=$(minikube ip --profile ${PROFILE})
$ echo ${MINIKUBE_IP_ADDR}
```

<br/>

```
// Check
// $ envsubst < Chapter07.01/manual_model_deployment/Ingress.yaml
```

<br/>

```
$ envsubst < Chapter07.01/manual_model_deployment/Ingress.yaml | kubectl create -f - -n ml-workshop
```

<br/>

```
$ kubectl get ingress -n ml-workshop | grep model-test
```

<br/>

response:

```
model-test             nginx   model-test.192.168.49.2.nip.io   192.168.49.2   80        74s
```

<br/>

```
$ kubectl create -f Chapter07.01/manual_model_deployment/http-echo-service.yaml -n ml-workshop
```

<br/>

```
$ kubectl get pods -n ml-workshop | grep logger
```

<br/>

response:

```
logger-848dd74654-967q9                                        1/1     Running     0             17s
```

<br/>

```
$ curl -vvvv -X POST 'http://model-test.192.168.49.2.nip.io/api/v1.0/predictions' --header 'Content-Type: application/json' --data-raw '{ "data": {"ndarray": [[2,1]] }}'
```

<br/>

response:

```
Note: Unnecessary use of -X or --request, POST is already inferred.
*   Trying 192.168.49.2:80...
* Connected to model-test.192.168.49.2.nip.io (192.168.49.2) port 80 (#0)
> POST /api/v1.0/predictions HTTP/1.1
> Host: model-test.192.168.49.2.nip.io
> User-Agent: curl/7.81.0
> Accept: */*
> Content-Type: application/json
> Content-Length: 32
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< Date: Sat, 01 Jul 2023 06:18:48 GMT
< Content-Type: application/json
< Content-Length: 164
< Connection: keep-alive
< Access-Control-Allow-Headers: Accept, Accept-Encoding, Authorization, Content-Length, Content-Type, X-CSRF-Token
< Access-Control-Allow-Methods: OPTIONS,POST
< Access-Control-Allow-Origin: *
< Seldon-Puid: 726da7c7-e5d2-4254-83dc-b7d44562e584
< X-Content-Type-Options: nosniff
<
{"data":{"names":["t:0","t:1","t:2","t:3"],"ndarray":[[0.25,0.25,0.25,0.25]]},"meta":{"requestPath":{"model-test-predictor":"webmakaka/hellomlflow-manual:1.0.0"}}}
* Connection #0 to host model-test.192.168.49.2.nip.io left intact
```

<br/>

```
$ export LOGGER_POD_NAME=$(kubectl get pod -o=custom-columns=NAME:.metadata.name -n ml-workshop | grep logger)

$ kubectl logs -f ${LOGGER_POD_NAME} -n ml-workshop
```

<br/>

response:

```
Listening on ports 8080 for http, and 8443 for https.
{
    "path": "/",
    "headers": {
        "host": "logger",
        "user-agent": "Go-http-client/1.1",
        "content-length": "32",
        "ce-endpoint": "predictor",
        "ce-id": "2c2e56c0-d6d3-4e33-81ff-deed1df0e270",
        "ce-inferenceservicename": "model-test",
        "ce-modelid": "model-test-predictor",
        "ce-namespace": "ml-workshop",
        "ce-requestid": "33e0d1d7-3bce-493d-af44-19d2763fc990",
        "ce-source": "http://:8000/",
        "ce-specversion": "1.0",
        "ce-time": "2023-07-01T06:37:57.124933676Z",
        "ce-traceparent": "00-a55bbd2bad1afadd7fd4456e4e1f9319-dbc701dafb46e15b-00",
        "ce-type": "io.seldon.serving.inference.request",
        "content-type": "application/json",
        "traceparent": "00-a55bbd2bad1afadd7fd4456e4e1f9319-60c9a89010bfa728-00",
        "accept-encoding": "gzip"
    },
    "method": "POST",
    "body": "{ \"data\": {\"ndarray\": [[2,1]] }}",
    "fresh": false,
    "hostname": "logger",
    "ip": "::ffff:172.17.0.1",
    "ips": [],
    "protocol": "http",
    "query": {},
    "subdomains": [],
    "xhr": false,
    "os": {
        "hostname": "logger-77f9f57b86-7hg2v"
    },
    "connection": {},
    "json": {
        "data": {
            "ndarray": [
                [
                    2,
                    1
                ]
            ]
        }
    }
}
::ffff:172.17.0.1 - - [01/Jul/2023:06:37:57 +0000] "POST / HTTP/1.1" 200 1202 "-" "Go-http-client/1.1"
{
    "path": "/",
    "headers": {
        "host": "logger",
        "user-agent": "Go-http-client/1.1",
        "content-length": "169",
        "ce-endpoint": "predictor",
        "ce-id": "585cb1d8-6767-41f5-aa25-2dd5a7ea3f73",
        "ce-inferenceservicename": "model-test",
        "ce-modelid": "model-test-predictor",
        "ce-namespace": "ml-workshop",
        "ce-requestid": "33e0d1d7-3bce-493d-af44-19d2763fc990",
        "ce-source": "http://:8000/",
        "ce-specversion": "1.0",
        "ce-time": "2023-07-01T06:37:57.129243763Z",
        "ce-traceparent": "00-b3b9fec139253df382acaa79a8af00a4-e5ca4f4725376ef5-00",
        "ce-type": "io.seldon.serving.inference.response",
        "content-type": "application/json",
        "traceparent": "00-b3b9fec139253df382acaa79a8af00a4-6accf6fd39af34c2-00",
        "accept-encoding": "gzip"
    },
    "method": "POST",
    "body": "{\"data\":{\"names\":[\"t:0\",\"t:1\",\"t:2\",\"t:3\"],\"ndarray\":[[0.25,0.25,0.25,0.25]]},\"meta\":{\"requestPath\":{\"model-test-predictor\":\"quay.io/marley/hellomlflow-manual:1.0.0\"}}}\n",
    "fresh": false,
    "hostname": "logger",
    "ip": "::ffff:172.17.0.1",
    "ips": [],
    "protocol": "http",
    "query": {},
    "subdomains": [],
    "xhr": false,
    "os": {
        "hostname": "logger-77f9f57b86-7hg2v"
    },
    "connection": {},
    "json": {
        "data": {
            "names": [
                "t:0",
                "t:1",
                "t:2",
                "t:3"
            ],
            "ndarray": [
                [
                    0.25,
                    0.25,
                    0.25,
                    0.25
                ]
            ]
        },
        "meta": {
            "requestPath": {
                "model-test-predictor": "quay.io/marley/hellomlflow-manual:1.0.0"
            }
        }
    }
}
::ffff:172.17.0.1 - - [01/Jul/2023:06:37:57 +0000] "POST / HTTP/1.1" 200 1609 "-" "Go-http-client/1.1"
```

<br/>

http://model-test.192.168.49.2.nip.io/prometheus
