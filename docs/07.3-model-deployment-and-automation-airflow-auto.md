# [OK!] Chapter 7. Model Deployment and Automation

<br/>

### Automating ML model deployments in Airflow

<br/>

Machine-Learning-on-Kubernetes/Chapter07.02/model_deploy_pipeline/

<br/>

File -> New -> Pipeline Editor

Rename model_deploy.pipeline

<br/>

Drag files on hello_world.pipeline

model_build_push -> build_push_image.py

model_deploy -> deploy_model.py

Add arrow from build_push_image.py to deploy_model.py

<br/>

**build_push_image.py**

Runtime Image: Kaniko Container Builder

<br/>

File Dependencies

```
Dockerfile
base_requirements.txt
Predictor.py
```

<br/>

```
Environment Variables

MODEL_NAME=mlflowdemo
MODEL_VERSION=1
CONTAINER_REGISTRY=https://index.docker.io/v1/
CONTAINER_REGISTRY_USER=webmakaka
CONTAINER_REGISTRY_PASSWORD=mypassword
CONTAINER_DETAILS=webmakaka/mlflowdemo:latest
```

<br/>

**deploy_model.py**

Runtime Image: Airflow Python Runner

<br/>

```
File Dependencies:

Ingress.yaml
SeldonDeploy.yaml
```

<br/>

```
Environment Variables

MODEL_NAME=mlflowdemo
MODEL_VERSION=1
CONTAINER_DETAILS=webmakaka/mlflowdemo:latest
CLUSTER_DOMAIN_NAME=192.168.49.2.nip.io
```

<br/>

```
Play

Pipeline Name: model_deploy
Runtime Platform: Apache Airflow runtime
Runtime Configuration: MyAirflow
```

<br/>

To pass this step, I edited build_push_image.py and manually specified:

```python
    access_key="minio",
    secret_key="minio123",
```

and from minio in mlflow bucket i take.

<br/>

```
data_file_model = minioClient.fget_object("mlflow", f"/2/726460da00bc4bedb7f70f20e08bc3b3/artifacts/model/model.pkl", "model.pkl")

data_file_requirements = minioClient.fget_object("mlflow", f"/2/726460da00bc4bedb7f70f20e08bc3b3/artifacts/mode
```

<br/>

[Success!]

New python script appeared in  
https://github.com/wildmakaka/airflow-dags/tree/main

<br/>

// DAG appears  
https://airflow.192.168.49.2.nip.io/home

<br/>

// Logs Appeared in airflow storage  
https://minio.192.168.49.2.nip.io/

<br/>

// Dockerhub
https://hub.docker.com/u/webmakaka/
