# Chapter 7. Model Deployment and Automation

<br/>

### Apache Airflow

// Create an empty repo  
https://github.com/wildmakaka/airflow-dags

<br/>

```
$ kubectl get pods -n ml-workshop | grep airflow
app-aflow-airflow-scheduler-6f9c44866d-hx9vw                   2/2     Running     2 (124m ago)    23h
app-aflow-airflow-web-6d9587698-4hk9w                          2/2     Running     4 (130m ago)    23h
app-aflow-airflow-worker-0                                     2/2     Running     2 (5h51m ago)   23h

```

<br/>

```
$ kubectl get ingress -n ml-workshop | grep airflow
```

<br/>

```
https://airflow.192.168.49.2.nip.io
```

<br/>

### Configuring Airflow runtime images

<br/>

https://jupyterhub.192.168.49.2.nip.io/

<br/>

```
Image: SciKit v.1.10 - Elyra Notebook Image
Container size: Small

Variable name: AWS_SECRET_ACCESS_KEY
Variable value: minio123

Secret: no
```

<br/>

Machine-Learning-on-Kubernetes/Chapter07/model_deploy_pipeline/

<br/>

File -> New -> Pipeline Editor

Rename hello_world.pipeline

<br/>

File > New Python File

Создать 2 файла

hello.py and world.py

<br/>

с содержимым:

```python
print('Hello airflow!')
```

Соединить стрелочкой.

<br/>

Runtime Images (слева) -> Добавить

<br/>

```
Name: Kaniko Container Builder

Description: A Kaniko container for building

Source: quay.io/ml-on-k8s/kaniko-container-builder:1.0.0

Image Pull Policy: IfNotPresent

SAVE & CLOSE
```

<br/>

```
Name: Airflow Python Runner

Description: A container with Python runtime

Source: quay.io/ml-on-k8s/airflow-python-runner:0.0.11

Image Pull Policy: IfNotPresent

SAVE & CLOSE
```

<br/>

Переоткрыть pipeline

```
hello.py -> Kaniko Container Builder
world.py -> Airflow Python Runner
```

<br/>

Runtimes (слева) + New Apache Airflow runtime

<br/>

```
Name: MyAirflow

Apache Airflow UI Endpoint: https://airflow.192.168.49.2.nip.io
Apache Airflow User Namespace: ml-workshop
Github API Endpoint: https://api.github.com
GitHub DAG Repository: wildmakaka/airflow-dags
GitHub DAG Repository Branch: main
Github Personal Access Token: YOUR_GITHUB_TOKEN


Cloud Object Storage Endpoint: http://minio-ml-workshop:9000
Cloud Object Storage Username: minio
Cloud Object Storage Password: minio123
Cloud Object Storage Bucket Name: airflow
```

<br/>

```
Play

Pipeline Name: hello_world
Runtime Platform: Apache Airflow runtime
Runtime Configuration: MyAirflow
```

<br/>

В бранче появился python скрипт.

https://github.com/wildmakaka/airflow-dags/tree/main

<br/>

https://airflow.192.168.49.2.nip.io/home

Появился DAG
